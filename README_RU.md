# Telegram Marketplace Bot

Telegram-бот для покупки и продажи товаров и услуг, построенный на Python и aiogram 3.x. Включает полноценную админ-панель с управлением пользователями/объявлениями, журналом действий и ролевой системой доступа.

> **Language / Язык:** [English version (README.md)](README.md)

## Возможности

### Пользовательские функции
- **Управление профилем** — Автоматическая регистрация по `/start`, редактирование профиля (телефон, местоположение, описание)
- **Управление объявлениями** — Создание, редактирование, удаление и пометка как проданных; до 5 фото на объявление
- **Поиск и фильтрация** — Поиск по ключевым словам, просмотр по категориям, фильтр по цене, пагинация
- **Категории** — 10 категорий товаров с эмодзи (электроника, одежда, дом и сад, транспорт, услуги, работа, животные, спорт, книги, другое)
- **Сообщения покупатель-продавец** — Прямое общение между пользователями через бота
- **Избранное** — Сохранение и управление интересными объявлениями
- **Приветственное изображение** — Визуальное главное меню с брендированной картинкой

### Админ-панель
- **Панель управления** — Статистика в реальном времени: пользователи (всего, активные, заблокированные, верифицированные, новые за день/неделю), объявления (всего, активные, проданные, отмеченные, новые за день/неделю), транзакции
- **Управление пользователями** — Просмотр/фильтрация (все, активные, заблокированные, верифицированные), блокировка/разблокировка с указанием причины, выдача предупреждений (низкая/средняя/высокая серьёзность), история предупреждений, просмотр объявлений пользователя
- **Управление объявлениями** — Просмотр/фильтрация (все, активные, отмеченные, удалённые), отметка/снятие отметки с указанием причины, удаление, просмотр информации о продавце
- **Журнал действий** — Автоматическое логирование всех действий администраторов с фильтрацией (блокировки, предупреждения, удаления, редактирования) и пагинацией
- **Ролевой доступ** — Три роли (super_admin, admin, moderator) с детальными правами доступа
- **Безопасность** — Трёхуровневая авторизация: белый список в .env → проверка роли в БД → проверка прав доступа

### Планируется (в будущем)
- Интеграция платёжной системы (заглушка реализована)
- Безопасные эскроу-транзакции
- Рейтинги и отзывы продавцов
- Отслеживание доставки
- Панель аналитики с графиками

## Структура проекта

```
telegram_marketplace_bot/
├── bot.py                          # Точка входа
├── config.py                       # Конфигурация и настройки
├── requirements.txt                # Зависимости
├── .env                            # Переменные окружения (не в git)
├── .env.example                    # Шаблон переменных окружения
│
├── assets/
│   └── images/
│       └── menu.jpg                # Изображение приветственного меню
│
├── database/
│   ├── __init__.py
│   ├── db.py                       # Подключение и инициализация БД (SQLite)
│   ├── models.py                   # Основные модели (User, Listing, ListingPhoto, Favorite, Message, Transaction)
│   └── admin_models.py             # Админ-модели (AdminUser, AdminAuditLog, UserWarning)
│
├── handlers/
│   ├── __init__.py                 # Регистрация и порядок роутеров
│   ├── common.py                   # /start, /help, /cancel, главное меню
│   ├── listings.py                 # CRUD-операции с объявлениями
│   ├── search.py                   # Поиск и просмотр по категориям
│   ├── messages.py                 # Общение покупатель-продавец
│   ├── profile.py                  # Управление профилем
│   └── admin/
│       ├── __init__.py
│       ├── admin_router.py         # Вход в админ-панель и панель управления
│       ├── user_management.py      # Блокировка, предупреждения, просмотр пользователей
│       ├── listing_management.py   # Отметка, удаление объявлений
│       ├── transaction_management.py  # Просмотр транзакций (заглушка)
│       ├── analytics.py            # Аналитика (заглушка)
│       └── audit.py                # Журнал действий с фильтрами
│
├── keyboards/
│   ├── __init__.py
│   ├── keyboards.py                # Пользовательские клавиатуры
│   └── admin_keyboards.py          # Клавиатуры админ-панели
│
├── states/
│   ├── __init__.py
│   └── states.py                   # FSM-состояния (Listing, Search, Message, Profile, Admin)
│
├── utils/
│   ├── __init__.py
│   ├── helpers.py                  # Форматирование, валидация, утилиты
│   ├── decorators.py               # @require_admin, @require_permission
│   └── admin_helpers.py            # Форматирование для админ-панели
│
├── middleware/
│   ├── __init__.py
│   ├── admin_auth.py               # Middleware аутентификации админов
│   └── audit_logger.py             # Middleware автоматического логирования
│
├── create_admin.py                 # Скрипт создания первого администратора
├── check_admin_setup.py            # Диагностика настройки админ-панели
└── migrate_database.py             # Утилита миграции базы данных
```

## Установка

1. **Клонируйте репозиторий**

2. **Создайте виртуальное окружение**:
   ```bash
   python -m venv venv
   source venv/bin/activate  # Windows: venv\Scripts\activate
   ```

3. **Установите зависимости**:
   ```bash
   pip install -r requirements.txt
   ```

4. **Настройте переменные окружения**:
   Создайте файл `.env` в корне проекта (см. `.env.example`):
   ```env
   BOT_TOKEN=ваш_токен_от_botfather
   ADMIN_TELEGRAM_IDS=123456789,987654321
   SUPER_ADMIN_ID=123456789
   ```

5. **Запустите бота**:
   ```bash
   python bot.py
   ```

6. **Настройте первого администратора** (после того как админ отправит `/start` боту):
   ```bash
   python create_admin.py
   ```

## Конфигурация

Все настройки находятся в `config.py`, конфиденциальные значения загружаются из `.env`:

| Параметр | Описание | По умолчанию |
|---|---|---|
| `BOT_TOKEN` | Токен бота Telegram (от @BotFather) | Обязательный |
| `DATABASE_URL` | Строка подключения к БД | `marketplace.db` (SQLite) |
| `ADMIN_TELEGRAM_IDS` | ID администраторов через запятую | Пусто |
| `SUPER_ADMIN_ID` | ID суперадминистратора | Нет |
| `MAX_PHOTOS` | Макс. фото на объявление | 5 |
| `MAX_TITLE_LENGTH` | Макс. длина заголовка | 100 |
| `MAX_DESCRIPTION_LENGTH` | Макс. длина описания | 2000 |
| `MIN_PRICE` / `MAX_PRICE` | Диапазон цен | 0.01 – 1 000 000 |
| `PAGE_SIZE` | Элементов на странице (пользователь) | 5 |
| `ADMIN_PAGE_SIZE` | Элементов на странице (админ) | 10 |
| `CURRENCY` | Символ валюты | `$` |

## База данных

### Движок
SQLite по умолчанию (`marketplace.db`, создаётся автоматически при первом запуске). Доступен путь миграции на PostgreSQL.

### Схема

| Таблица | Описание |
|---|---|
| `users` | Аккаунты, профили, статус верификации, информация о блокировке, счётчик предупреждений |
| `listings` | Объявления с полями статуса, просмотров, отметок |
| `listing_photos` | Фотографии объявлений (Telegram file_id, флаг основной фото) |
| `favorites` | Избранные объявления пользователей |
| `messages` | Сообщения покупатель-продавец со статусом прочтения |
| `transactions` | Платёжные транзакции (заглушка) |
| `admin_users` | Роли и права администраторов (JSON) |
| `admin_audit_log` | Журнал всех действий администраторов |
| `user_warnings` | Предупреждения пользователям с уровнями серьёзности |

### Переход на PostgreSQL
1. Установите `asyncpg`: `pip install asyncpg`
2. Обновите `DATABASE_URL` в `.env`:
   ```
   DATABASE_URL=postgresql://user:password@localhost/marketplace
   ```
3. Обновите драйвер БД в `database/db.py`

## Использование

### Команды бота

| Команда | Описание |
|---|---|
| `/start` | Запуск бота, отображение главного меню с приветственным изображением |
| `/search` | Поиск объявлений |
| `/mylistings` | Просмотр ваших объявлений |
| `/favorites` | Просмотр избранного |
| `/profile` | Просмотр/редактирование профиля |
| `/help` | Справочная информация |
| `/cancel` | Отмена текущей операции |
| `/admin` | Открыть админ-панель (только для администраторов) |

### Для покупателей
1. `/start` для регистрации и отображения главного меню
2. Просматривайте объявления или используйте поиск с фильтрами
3. Фильтруйте по категории, ключевым словам или диапазону цен
4. Свяжитесь с продавцом напрямую через бота
5. Сохраняйте интересные товары в избранное

### Для продавцов
1. Перейдите в «Мои объявления» → «Добавить объявление»
2. Следуйте подсказкам: название → описание → цена → категория → фото → местоположение
3. Управляйте объявлениями (редактируйте, удаляйте, отмечайте как проданные)
4. Отвечайте на запросы покупателей

### Админ-панель
1. Убедитесь, что ваш Telegram ID указан в `ADMIN_TELEGRAM_IDS` в `.env`
2. Отправьте `/start` боту, затем выполните `python create_admin.py`
3. Используйте `/admin` для входа в админ-панель
4. Навигация: Панель управления, Пользователи, Объявления, Журнал действий

#### Роли администраторов

| Роль | Права доступа |
|---|---|
| `super_admin` | Все права, включая управление администраторами |
| `admin` | Все права, кроме управления администраторами |
| `moderator` | Управление объявлениями, предупреждения, аналитика, редактирование объявлений |

## Архитектура

### Приоритет роутеров
Роутеры регистрируются в следующем порядке (ранний = более высокий приоритет):
1. `admin_router` — Админ-панель и все подроутеры
2. `listings_router` — CRUD-операции с объявлениями
3. `search_router` — Поиск и фильтрация
4. `messages_router` — Общение покупатель-продавец
5. `profile_router` — Управление профилем
6. `common_router` — Общие обработчики (/start, /help, /cancel)

### FSM-состояния
- **ListingStates** — 7 состояний создания + 5 состояний редактирования
- **SearchStates** — 5 состояний поиска
- **MessageStates** — 2 состояния сообщений
- **ProfileStates** — 3 состояния редактирования профиля
- **AdminStates** — 6 состояний админ-операций (блокировка, предупреждение, отметка, редактирование, удаление, фильтрация)

### Middleware
- **AdminAuthMiddleware** — Выполняется при каждом сообщении/callback, добавляет `admin` и `is_admin` в данные обработчика
- **AuditLoggerMiddleware** — Автоматически логирует действия администраторов после выполнения обработчика

### Паттерны callback-данных
- Простые: `"action"` (например, `"help"`, `"cancel"`)
- С ID: `"action:id"` (например, `"view_listing:123"`)
- Пагинация: `"action:page"` (например, `"browse:2"`)
- С несколькими параметрами: `"action:param1:param2"` (например, `"admin_warn_severity:123:high"`)

## Технологический стек

| Компонент | Технология |
|---|---|
| Фреймворк | aiogram 3.4.1 |
| База данных | SQLite (aiosqlite) |
| Конфигурация | python-dotenv |
| Язык | Python 3.11+ |
| Асинхронность | Полностью async/await |

## Масштабируемость

- **База данных**: Готова к миграции на PostgreSQL
- **FSM-хранилище**: В памяти (для продакшена используйте Redis для сохранения состояния)
- **Модульная архитектура**: Разделённые обработчики, клавиатуры, модели, middleware
- **Асинхронность**: Все обработчики и операции с БД асинхронные
- **Индексы**: Настроены на часто используемых столбцах
- **Фотографии**: Хранятся по Telegram file_id (без локального хранилища)

## Лицензия

MIT License — свободно используйте и модифицируйте.
